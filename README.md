## 1. Тема и целевая аудитория

В работе рассматривается *картографический сервис*. Пример так таких сервисов и размер их аудитории:

| Сервис      | MAU             |
| ----------- | --------------- |
| Google Maps | ~1.5 млрд. [^1] |
| Apple Maps  | 590 млн.[^1]    |
| Maps Me     | 60 млн.[^2]     |
| Waze        | 140 млн.[^3]    |
| MapQuest    | 40 млн.[^4]     |

### MAU

Исходя из представленных данных, потенциальная максимальная месячная аудитория сервиса может составлять **150-200 млн.** пользователей (Google Maps и Apple Maps вероятнее всего достигли выдающих размеров аудитории в том числе за счет переустановки приложений в Android и IOS[^1]).

### DAU

Известна статистика об использовании картографических приложений: 11.3% пользователей используют приложения каждый день, 39% множество раз в неделю (допустим 5 раз в неделю), 27% несколько раз в неделю (допустим 3 раза в неделю), 19.5% используют несколько раз в месяц (допустим 3 раза в месяц) [^5]. Исходя их этого, можно рассчитать что DAU составляет `11.3 + 39 * 5/7+27 * 3/7 + 19.5 * 3/30 = 52.7%` от MAU. Таким образом, для проектируемого сервиса, число ежедневных пользователей - **80-105 млн.**

### Расположение аудитории

Сервисы-аналоги обслуживают аудиторию со всего мира. Исходя из данных по распределению пользователей Интернета по частям света[^6] , можно рассчитывать на следующие размеры аудитории (тут и далее положим MAU и DAU сервиса **175 млн.** и **93 млн.** соответственно):

| Регион              | MAU, млн | DAU, млн |
| ------------------- | -------- | -------- |
| Северная Америка    | 11.8     | 6.2      |
| Южная Америка       | 16.8     | 8.9      |
| Европа              | 31.9     | 16.9     |
| Азия                | 93.5     | 49.7     |
| Африка              | 20.1     | 10.7     |
| Австралия и Океания | 1.05     | 0.6      |

### MVP

Ключевой функционал сервиса:

1. Просмотр тайловой карты
2. Геокодинг (поиск координат по адресу)
3. Построение маршрутов

## 2. Расчет нагрузки
### Действия пользователя

Согласно исследованию поведения пользователей в картографических приложениях, среднее время пользовательской сессии составляет 65 секунд[^5], пользователь использует приложение несколько раз в день (1-3 раза). Из этого же исследования известно распределение времени сессии на взаимодействие с функционалом сервиса:

<img src="/mnt/files/Notes/TPark/hl-course-work/img/map_usage.png" alt="map_usage" align="center" style="zoom:50%;" />

* Map-View Manipulations занимают 67.5% времени сессии. В это взаимодействие входит просмотр, зум и скролинг карты.
  Т.о. манипуляции с просмотром карты занимают в среднем 44 секунды. Предположим что пользователь за это время может обновить экран c карт 6-8 раз (с учетом смены зума). 

  При смене положения карты/уровня зума, происходит запрос тайлов карты. Размер тайлов, обычно 256х256 пикселей и для покрытия экрана 1920х1080 пикселей требуется 40 тайлов. Таким образом за время сессии будет запрашиваться примерно **280 тайлов**. 

* Direction (построение маршрутов) занимают 21.1% времени сессии, т.е. 14 секунд, предположим что за это время пользователь делает **1-2 запроса** на построение маршрута. 

* Place и Search запросы (геокодинг) занимаю 11.4% времени или 8 секунд. За это время пользователь может успеть сделать **3-4 запроса**.



### RPS

Рассчитаем нагрузку на сервис с учетом, что пользователи используют сервис 2 раза в день, а пользователи используют сервис в основном в дневное время, т.е. на промежутке в 12-14 часов приходится основная масса запросов:

1. Просмотр тайловой карты: `93000000 * 280 * 2  / (13 * 60 * 60) = 1112820 RPS`.
2. Геокодинг: `93000000 * 2 * 2  / (13 * 60 * 60) = 7948 RPS`
3. Построение маршрутов: `93000000 * 2 * 2  / (13 * 60 * 60) = 15897 RPS`

Сводная таблица по запросам:

| Тип запроса             | RPS         |
| ----------------------- | ----------- |
| Просмотр тайловой карты | 1\'112\'820 |
| Геокодинг               | 15\'897     |
| Построение маршрутов    | 7\'948      |
| **Итого**               | 1\'136\'665 |



### Трафик

Рассмотрим нагрузку сетевого трафика. В расчетах будем полагаться, что:

* Тайлы представлены в векторном формате[^7] и занимают в серднем **30 КБ**.
* Построенные маршруты представляют собой набор точек на тайлах и занимают **5КБ**.
* Ответы на гекодинг запросы представляют собой точу на тайле/адрес и занимают **1КБ**

Пиковое потребление предполагает увеличение нагрузки в 2 раза.

#### Трафик входящий

1. Загрузка тайла: 

   * Пиковое потребление: `1 КБ * 2 * 1112820 RPS = 2225640 КБ/c = 17.8 ГБит/с`

   * Суточное потребление: `1 КБ * 93000000 RPS = 93 ГБ `

2. Геокодинг:

   * Пиковое потребление: `1 КБ * 2 * 15897 RPS = 31794 КБ/c = 0.254 ГБит/с`

   * Суточное потребление: `1 КБ * 93000000 RPS = 93 ГБ `

3. Построение маршрутов: 

   * Пиковое потребление: `1 КБ * 2 * 7948 RPS = 15896 КБ/c = 0.127 ГБит/с`

   * Суточное потребление: `1 КБ * 93000000 RPS = 93 ГБ `

| Запрос               | Объем 1 запроса | Пиковое потребление (ГБит/с) | Суточное потребление (ГБ/Сутки) |
| -------------------- | --------------- | ---------------------------- | ------------------------------- |
| Загрузка тайла       | 1 КБ            | 17.8                         | 93                              |
| Гекодинг             | 1 КБ            | 0.254                        | 93                              |
| Построение маршрутов | 1 КБ            | 0.127                        | 93                              |

#### Трафик исходящий

1. Загрузка тайла: 

   * Пиковое потребление: `30 КБ * 2 * 1112820 RPS = 66769200 КБ/c = 534 ГБит/с`

   * Суточное потребление: `30 КБ * 93000000 RPS = 2790 ГБ `

2. Геокодинг:

   * Пиковое потребление: `1 КБ * 2 * 15897 RPS = 31794 КБ/c = 0.254 ГБит/с`

   * Суточное потребление: `1 КБ * 93000000 RPS = 93 ГБ `

3. Построение маршрутов: 

   * Пиковое потребление: `5 КБ * 2 * 7948 RPS = 79480 КБ/c = 0.63 ГБит/с`

   * Суточное потребление: `5 КБ * 93000000 RPS = 465 ГБ `

| Запрос               | Объем 1 запроса | Пиковое потребление (ГБит/с) | Суточное потребление (ГБ/Сутки) |
| -------------------- | --------------- | ---------------------------- | ------------------------------- |
| Загрузка тайла       | 30 КБ           | 534                          | 2790                            |
| Гекодинг             | 1 КБ            | 0.254                        | 93                              |
| Построение маршрутов | 5 КБ            | 0.254                        | 465                             |



## 3. Логическая схема

### Требования
* Размер хранения в разбивке по типам данных (в Тб) - для существенных блоков данных
* Картинка со списком таблиц, полей и связей между ними без привязки к конкретным базам и шардингу
## 4. Физическая схема
### Требования
* Картинка со списком таблиц, полей и связей между ними с привязкой к конкретным базам, с указанием индексов и схемы шардинга
## 5. Технологии
Сводная таблица: технология, область примерения, мотивационная часть
## 6. Схема проекта
Схема взаимодействия сервисов внутри проекта (картинка). Должно быть описано как ходят потоки данных, как устроена балансировка (внутренняя и внешняя).
## 7. Список серверов
Таблица с конфигурациями, количеством серверов и сервисами расположенными на них. В случае использования kubernetes или иной виртуализации, список контейнеров с аллокацией ресурсов.



## 8. Список источников

[^1]: How many pepople use google maps compared to apple maps - [www.justinobeirne.com](https://www.justinobeirne.com/how-many-people-use-google-maps-compared-to-apple-maps)

[^2]: Mapsme - [ru.maps.me](https://ru.maps.me/app/)

[^3]: Waze statistic and facts - [expandedramblings.com](https://expandedramblings.com/index.php/waze-statistics-facts/)

[^4]: Your Waze map will now show you restaurants that are selling discounted leftover food - [www.fastcompany.com](https://www.fastcompany.com/90666431/your-waze-map-will-now-show-you-restaurants-that-are-selling-discounted-leftover-food)

[^5]: Gian-Luca Savino. MapRecorder: analysing real-world usage of mobile map applications - [www.tandfonline.com](https://www.tandfonline.com/doi/epub/10.1080/0144929X.2020.1714733?needAccess=true)

[^6]: Internet Usage Statistic - [www.internetworldstats.com](https://www.internetworldstats.com/stats.htm)
[^7]: Как мы делаем карту для тех, кто делает карту - [habr.com](https://habr.com/ru/company/2gis/blog/341508/)
